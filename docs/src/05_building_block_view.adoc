ifndef::imagesdir[:imagesdir: ../images]

=== Level 1

[[section-building-block-view]]
== Building Block View

=== Whitebox Overall System

[plantuml, target=level1-overall, format=png]
....
@startuml
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_WITH_LEGEND()

title Building Block View (Level 1) - Gamey System with Firebase

Person(player, "Player", "User interacting with the game and managing their profile.")
System_Ext(firebase, "Firebase", "External platform providing Authentication, Firestore (NoSQL), and Hosting.")

System_Boundary(c1, "Gamey Ecosystem") {
    Container(webapp, "Webapp", "React, TS, Vite", "Main UI. Handles real-time game rendering and Firebase SDK integration.")
    Container(users_svc, "Users Service", "Node.js, Express", "Internal management service. Validates tokens via Firebase Admin SDK.")
    Container(gamey_engine, "Game Engine", "Rust", "High-performance core for game rules, notations, and bot orchestration.")
}

Rel(player, webapp, "Uses", "HTTPS")
Rel(webapp, firebase, "Auth / Sync data", "Firebase SDK (Web)")
Rel(webapp, users_svc, "Business requests", "JSON/HTTPS")
Rel(webapp, gamey_engine, "Submits moves", "WebSockets/gRPC")
Rel(users_svc, firebase, "Verify tokens / Admin DB access", "Firebase Admin SDK")
@enduml
....



Motivation::
The system uses a hybrid backend approach. **Firebase** is used as a Third-Party Building Block to offload identity management and real-time state persistence. This allows the **Users Service** to focus on custom business logic and the **Game Engine** (Rust) to handle CPU-intensive game mechanics without managing user sessions directly.

Contained Building Blocks::
[cols="1,2" options="header"]
|===
| **Name** | **Responsibility**
| **Webapp** | Frontend SPA that coordinates User-Firebase-Engine interactions.
| **Users Service** | Backend orchestration, monitoring, and providing an OpenAPI-compliant gateway for administrative tasks.
| **Game Engine** | High-speed game processing, bot AI management, and move validation.
| **Firebase** | External black box providing Authentication and cloud-based data storage.
|===

Important Interfaces::
* **Firebase SDK Interface:** Client-side link for Auth and Realtime updates.
* **Gamey WebSocket/gRPC:** Low-latency interface for game move submission to the Rust engine.

==== Webapp
Purpose/Responsibility::
Coordinates the user experience. It uses Firebase for Authentication and the Game Engine for the actual gaming logic.
Interface(s)::
React Hooks for Firebase; REST client for Users Service.
Directory/File Location::
`/webapp`

==== Users Service
Purpose/Responsibility::
Provides a secure layer for user-related logic that shouldn't live on the client. It uses the Firebase Admin SDK to verify identities.
Interface(s)::
Exposes endpoints defined in `openapi.yaml`.
Directory/File Location::
`/users`

==== Game Engine
Purpose/Responsibility::
The computational core. It is agnostic of user identity (delegated to other blocks) and focuses on the game rules.
Directory/File Location::
`/gamey`

=== Level 2

==== White Box _Game Engine (Rust)_

[plantuml, target=level2-gamey, format=png]
....
@startuml
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

Container_Boundary(gamey_internal, "Game Engine (Rust)") {
    Component(core, "Core Logic", "Rust Mod", "State machine and rules.")
    Component(notation, "Notation Parser", "Rust Mod", "Processes game notations (FEN/PGN).")
    Component(bot_server, "Bot Manager", "Rust Mod", "Handles AI agent lifecycle.")
    Component(gamey_error, "Error Handler", "Rust Mod", "Domain-specific error types.")
}

Rel(bot_server, core, "Queries rules")
Rel(core, notation, "Serializes state")
Rel(core, gamey_error, "Triggers")
@enduml
....

The **Game Engine** is organized as a modular Rust crate. The `core` module is strictly separated from the `bot_server` to allow for local CLI usage or networked server usage.

==== White Box _Users Service (Node.js)_
1. **users-service.js**: Main entry point using Express.
2. **Firebase Admin Logic**: Middleware to intercept requests and validate Firebase JWT tokens.
3. **monitoring/**: Dedicated module for service health and logging.

=== Level 3
(Not really sure if it is even detailed)